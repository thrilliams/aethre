(function(fa){"object"===typeof exports&&"undefined"!==typeof module?module.exports=fa():"function"===typeof define&&define.amd?define([],fa):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).NesNes=fa()})(function(){return function d(e,f,h){function b(c,g){if(!f[c]){if(!e[c]){var k="function"==typeof require&&require;if(!g&&k)return k(c,!0);if(a)return a(c,!0);g=Error("Cannot find module '"+c+"'");throw g.code="MODULE_NOT_FOUND",g;}g=f[c]=
{exports:{}};e[c][0].call(g.exports,function(a){var g=e[c][1][a];return b(g?g:a)},g,g.exports,d,e,f,h)}return f[c].exports}for(var a="function"==typeof require&&require,g=0;g<h.length;g++)b(h[g]);return b}({1:[function(e,f,h){h.readFile=function(d,b){var a=new XMLHttpRequest;a.open("GET",d);a.responseType="arraybuffer";a.onload=function(){b(a.response)};a.onerror=function(a){throw a;};a.send(null)}},{}],2:[function(e,f,h){f.exports={input:[{type:"standard",controls:[{type:"keyboard",config:{z:"a",
x:"b",shift:"select","return":"start",up:"up",down:"down",left:"left",right:"right"}},{type:"gamepad",config:{index:0,buttons:{0:"b",1:"a",2:"a",3:"b",8:"select",9:"start"},axes:{0:"horizontal",1:"vertical",4:"horizontal",5:"vertical"}}}]},{type:"standard",controls:{type:"gamepad",config:{index:1,buttons:{0:"b",1:"a",2:"a",3:"b",8:"select",9:"start"},axes:{0:"horizontal",1:"vertical",4:"horizontal",5:"vertical"}}}}]}},{}],3:[function(e,f,h){function d(a){this.config=p;this.tickAPU=this.frameEnded=
!1;this.controllers=new l;this.input=new F(this);this.output=new k;a&&this.output.video.setElement(a);this.interval=null;this.running=!1;this.paused=!0;this.memory=this.ppu=this.apu=this.cpu=this.cartridge=null;Object.preventExtensions(this)}var b=e("./system/cpu"),a=e("./system/apu"),g=e("./system/ppu"),c=e("./system/cartridge"),l=e("./system/controllers"),k=e("./system/output"),pa=e("./system/memory"),qa=e("./utils"),F=e("./system/input"),p=e("./config.json");d.prototype={load:function(a,c){var b=
this;qa.readFile(a,function(a){b.initCartridge(a);"function"===typeof c?c():!0===c&&b.run()})},run:function(){if(!this.interval){var a=this;this.interval=setInterval(function(){a.paused||a.runFrame()},1E3/60);this.output.video.run();this.running=!0;this.paused=!1}},runFrame:function(){for(var a=this.cpu,c=this.ppu,b=this.apu;!c.frameEnded;)a.tick(),c.tick(),c.tick(),c.tick(),this.tickAPU&&b.tick(),this.tickAPU=!this.tickAPU;c.frameEnded=!1},simulate:function(a){var c=a/1E3*60;for(a=0;a<c;a++)this.runFrame()},
play:function(){this.paused=!1;this.running||this.run()},pause:function(){this.paused=!0},toggle:function(){this.paused?this.play():this.pause();return this.paused},initCartridge:function(a){this.cartridge=new c(a,this);this.initCore();this.reset()},loadCartridge:function(a){this.memory.loadCartridge(a);this.ppu.memory.loadCartridge(a)},initCore:function(){this.cpu=new b(this);this.apu=new a(this);this.ppu=new g(this);this.memory=new pa(this);this.loadCartridge(this.cartridge)},reset:function(){this.cpu.reset();
this.apu.reset()}};f.exports=d},{"./config.json":2,"./system/apu":6,"./system/cartridge":10,"./system/controllers":11,"./system/cpu":13,"./system/input":16,"./system/memory":25,"./system/output":27,"./system/ppu":33,"./utils":1}],4:[function(e,f,h){function d(){this.enabled=!1;this.lengthCounter=0;this.lengthCounterHalt=!1;this.masterVolume=this.volume=this.sample=0;this.envelopeStart=!0;this.envelopeLoop=!1;this.envelopeDividerCount=this.envelopeDividerPeriod=this.envelopeCounter=0;this.envelopeDisabled=
!1}d.prototype={toggle:function(a){a?this.enable():this.disable()},disable:function(){this.enabled=!1;this.lengthCounter=0},enable:function(){this.enabled=!0},doLengthCounter:function(){this.lengthCounter&&!this.lengthCounterHalt&&this.lengthCounter--},setLengthCounter:function(a){this.enabled&&(this.lengthCounter=b[a])},doEnvelope:function(){this.envelopeStart?(this.envelopeStart=!1,this.envelopeCounter=15,this.envelopeDividerCount=this.envelopeDividerPeriod):this.envelopeDividerCount?(--this.envelopeDividerCount,
0===this.envelopeDividerCount&&(0===this.envelopeCounter&&this.envelopeLoop?this.envelopeCounter=15:this.envelopeCounter&&--this.envelopeCounter,this.envelopeDividerCount=this.envelopeDividerPeriod)):this.envelopeCounter=0;this.masterVolume=this.envelopeDisabled?this.volume:this.envelopeCounter},setEnvelope:function(a){this.volume=a&15;this.lengthCounterHalt=this.envelopeLoop=!!(a&32);this.envelopeDisabled=!!(a&16);this.envelopeDividerPeriod=this.volume+1;this.envelopeStart=!0}};var b=[10,254,20,
2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];f.exports=d},{}],5:[function(e,f,h){function d(g){this.apu=g;this.timerMax=a[0];this.timer=this.period;this.silence=!1;this.sampleBuffer=this.sampleBytesLeft=this.sampleLength=this.sampleCurrentAddress=this.sampleAddress=this.output=0;this.interrupt=this.loop=!1;this.bitsLeft=8;this.shifter=0;this.irqEnabled=!1;b.call(this);Object.preventExtensions(this)}var b=e("./channel");d.prototype=new b;d.prototype.writeRegister=
function(b,c){switch(b){case 0:this.irqEnabled=!!(c&128);this.irqEnabled||(this.interrupt=!1);this.loop=!!(c&64);this.timerMax=this.timer=a[c&15]>>>1;break;case 1:this.output=c&127;break;case 2:this.sampleAddress=this.sampleCurrentAddress=49152|c<<6;break;case 3:this.sampleLength=this.sampleBytesLeft=c&&c<<4|1}};d.prototype.doTimer=function(){this.timerMax&&(this.timer--,0>=this.timer&&(this.sample=this.silence?0:this.output=this.shifter&1?Math.min(this.output+2,127):Math.max(this.output-2,0),this.shifter>>>=
1,this.bitsLeft--,this.bitsLeft||(this.bitsLeft=8,(this.silence=!this.sampleBytesLeft)||this.readSample()),this.timer+=this.timerMax));this.irqEnabled&&this.interrupt&&this.apu.system.cpu.requestIRQ()};d.prototype.readSample=function(){this.shifter=this.sampleBuffer;this.sampleBuffer=this.apu.system.memory.read(this.sampleCurrentAddress);this.sampleCurrentAddress++;65535===this.sampleCurrentAddress&&(this.sampleCurrentAddress=32768);this.sampleBytesLeft--;this.sampleBytesLeft||(this.sampleCurrentAddress=
this.sampleAddress,this.loop?this.sampleBytesLeft=this.sampleLength:this.interrupt=this.irqEnabled)};var a=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54];f.exports=d},{"./channel":4}],6:[function(e,f,h){function d(d){this.system=d;this.output=d.output.audio;this.sampleCounter=0;this.sampleCounterMax=894886.5/this.output.sampleRate;this.frameCounterMode=0;this.frameCounterInterrupt=!1;this.cycles=this.frameCount=0;this.pulse1=new b;this.pulse2=new b;this.triangle=new a;this.noise=new g;
this.dmc=new c(this);Object.preventExtensions(this)}var b=e("./pulse"),a=e("./triangle"),g=e("./noise"),c=e("./dmc");d.prototype={reset:function(){this.writeStatus(0)},readRegister:function(a){return 21===a?this.readStatus():0},readStatus:function(){return!!this.pulse1.lengthCounter<<0|!!this.pulse2.lengthCounter<<1|!!this.triangle.lengthCounter<<2|!!this.noise.lengthCounter<<3|!!this.dmc.sampleBytesLeft<<4},writeRegister:function(a,c){4>a?this.pulse1.writeRegister(a,c):8>a?this.pulse2.writeRegister(a-
4,c):12>a?this.triangle.writeRegister(a-8,c):16>a?this.noise.writeRegister(a-12,c):20>a?this.dmc.writeRegister(a-16,c):21===a?this.writeStatus(c):23===a&&(this.frameCounterMode=+!!(c&128),this.frameCounterInterrupt=!(c&64),this.cycles=0,this.frameCounterMode&&(this.doQuarterFrame(),this.doHalfFrame()))},writeStatus:function(a){this.pulse1.toggle(a&1);this.pulse2.toggle(a&2);this.triangle.toggle(a&4);this.noise.toggle(a&8)},tick:function(){switch(this.frameCounterMode){case 0:this.tick0();break;default:this.tick1()}this.cycles+=
1;this.updateSample()},tick0:function(){switch(this.cycles){case 3728:case 7457:case 11186:case 14915:this.doQuarterFrame()}switch(this.cycles){case 7457:case 14915:this.doHalfFrame()}14915<=this.cycles&&(this.cycles=0,this.frameCounterInterrupt&&this.system.cpu.requestIRQ())},tick1:function(){switch(this.cycles){case 3729:case 7457:case 11186:case 18641:this.doQuarterFrame()}switch(this.cycles){case 7457:case 18641:this.doHalfFrame()}18641<=this.cycles&&(this.cycles=0)},doQuarterFrame:function(){this.pulse1.doEnvelope();
this.pulse2.doEnvelope();this.noise.doEnvelope();this.triangle.doLinearCounter()},doHalfFrame:function(){this.pulse1.doSweep();this.pulse1.doLengthCounter();this.pulse2.doSweep();this.pulse2.doLengthCounter();this.triangle.doLengthCounter();this.noise.doLengthCounter()},updateSample:function(){this.pulse1.doTimer();this.pulse2.doTimer();this.triangle.doTimer();this.noise.doTimer();this.dmc.doTimer();if(this.output.enabled){if(this.sampleCounter>=this.sampleCounterMax){var a=l[this.pulse1.sample+this.pulse2.sample];
var c=k[3*this.triangle.sample+2*this.noise.sample+this.dmc.sample];this.output.writeSample(a+c);this.sampleCounter-=this.sampleCounterMax}this.sampleCounter+=1}}};e=0;var l=new Float32Array(31);for(e=0;31>e;e++)l[e]=95.52/(8128/e+100);var k=new Float32Array(203);for(e=0;203>e;e++)k[e]=163.67/(24329/e+100);f.exports=d},{"./dmc":5,"./noise":7,"./pulse":8,"./triangle":9}],7:[function(e,f,h){function d(){this.shift=1;this.mode=0;this.timerMax=a[0];this.timer=this.period;this.index=3;b.call(this);Object.preventExtensions(this)}
var b=e("./channel");d.prototype=new b;d.prototype.doTimer=function(){if(this.timerMax)if(this.timer)this.timer--;else{var a=this.mode?(this.shift&64)>>6:(this.shift&2)>>1;a=(this.shift^a)&1;this.shift>>>=1;this.shift|=a<<14;this.sample=!this.lengthCounter||this.shift&1?0:this.masterVolume;this.timer+=this.timerMax}};d.prototype.writeRegister=function(b,c){switch(b){case 0:this.setEnvelope(c);break;case 2:this.mode=(c&128)>>>7;this.timerMax=this.timer=a[c&15];break;case 3:this.setLengthCounter(c>>>
3),this.envelopeStart=!0}};var a=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068];f.exports=d},{"./channel":4}],8:[function(e,f,h){function d(){this.duty=this.timer=this.timerMax=0;this.sweepStart=!0;this.sweepEnabled=!1;this.sweepDividerCount=this.sweepDividerPeriod=0;this.sweepNegate=!1;this.pulseCounter=this.sweepShiftCount=0;this.silence=!1;b.call(this);Object.preventExtensions(this)}var b=e("./channel");d.prototype=new b;d.prototype.doSweep=function(){var a=!this.sweepDividerCount,
c=0;this.sweepStart&&(this.sweepDividerCount=this.sweepDividerPeriod,this.sweepStart=!1);a?(this.sweepShiftCount&&(c=this.timerMax>>>this.sweepShiftCount),this.sweepNegate&&(c=-c),a=this.timerMax+c,8<=this.timerMax&&2047>=this.timerMax?(this.sweepEnabled&&(this.timerMax=a),this.silence=!1):this.silence=!0,this.sweepDividerCount=this.sweepDividerPeriod):this.sweepDividerCount&&this.sweepDividerCount--};d.prototype.doTimer=function(){!this.silence&&this.lengthCounter&&this.timerMax?this.timer?this.timer--:
(this.timer+=this.timerMax,this.pulseCounter=this.pulseCounter+1&7,this.sample=a[(this.duty<<3)+this.pulseCounter]*this.masterVolume):this.sample=0};d.prototype.writeRegister=function(a,c){switch(a){case 0:this.duty=(c&192)>>6;this.setEnvelope(c);break;case 1:this.sweepStart=!0;this.sweepEnabled=!!(c&128);this.sweepDividerPeriod=((c&112)>>4)+1;this.sweepNegate=!!(c&8);this.sweepShiftCount=c&7;break;case 2:this.timer=this.timerMax=this.timerMax&-256|c;break;case 3:this.timer=this.timerMax=this.timerMax&
-65281|(c&7)<<8,this.setLengthCounter(c>>>3),this.envelopeStart=!0,this.pulseCounter=0}this.silence=8>this.timerMax};var a=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1];f.exports=d},{"./channel":4}],9:[function(e,f,h){function d(){this.linearCounterMax=this.linearCounter=0;this.linearCounterStart=this.linearCounterControl=!1;this.sequenceCounter=this.timer=this.timerMax=0;b.call(this);Object.preventExtensions(this)}var b=e("./channel");d.prototype=new b;d.prototype.doLinearCounter=
function(){this.linearCounterStart?this.linearCounter=this.linearCounterMax:this.linearCounter&&this.linearCounter--;this.linearCounterControl||(this.linearCounterStart=!1)};d.prototype.doTimer=function(){this.timerMax&&(this.timer-=2,0>=this.timer&&(this.timer+=this.timerMax,this.sequenceCounter=this.sequenceCounter+1&31,this.sample=a[this.sequenceCounter]));this.lengthCounter&&this.linearCounter||(this.sample=0)};d.prototype.writeRegister=function(a,c){switch(a){case 0:this.linearCounterMax=c&-129;
this.lengthCounterHalt=this.linearCounterControl=!!(c&128);break;case 2:this.timer=this.timerMax=this.timerMax&-256|c;break;case 3:this.timer=this.timerMax=this.timerMax&-65281|(c&7)<<8,this.setLengthCounter(c>>>3),this.linearCounterStart=!0}};var a=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];f.exports=d},{"./channel":4}],10:[function(e,f,h){function d(a,b){this.system=b;this.raw=a;this.data=new Uint8Array(a,16,a.byteLength-16);this.header=new Uint8Array(a,0,16);
this.validate();this.initHeader();this.initData();Object.preventExtensions(this)}var b=e("./mappers");d.prototype={validate:function(){if(78!==this.header[0]||69!==this.header[1]||83!==this.header[2]||26!==this.header[3])throw Error("Invalid ROM!");if(this.header[7]&14)throw Error("Bit 1-3 of byte 7 in ROM header must all be zeroes!");if(this.header[9]&254)throw Error("Bit 1-7 of byte 9 in header must all be zeroes!");var a;for(a=10;15>=a;a++)if(this.header[a])throw Error("Byte "+a+" in ROM header must be zero.");
if(this.header[6]&4)throw Error("Trained ROMs are not supported");},initHeader:function(){var a=this.header[6];this.mirroring=a&1?1:0;this.battery=a&2;this.trainer=a&4;this.mirroring=a&8?2:this.mirroring;var b=this.header[7];this.vs=b&1;this.mapper=(a&240)>>4|b&240;this.pal=this.header[9]&1},initData:function(){this.prgBanks=this.header[4];this.chrBanks=this.header[5];this.ramBanks=this.header[8]||1;this.prgSize=16384*this.prgBanks;this.chrSize=8192*this.chrBanks;this.ramSize=8192*this.ramBanks;this.prgData=
this.data.subarray(0,this.prgSize);this.chrData=this.chrBanks?this.data.subarray(this.prgSize,this.prgSize+this.chrSize):new Uint8Array(8192);this.ramData=new Uint8Array(this.ramSize);this.initMapper()},initMapper:function(){this.prgRead=new Uint8Array(32768);this.prgRead.set(this.prgData.subarray(0,8192));this.chrRead=new Uint8Array(8192);this.chrRead.set(this.chrData.subarray(0,8192));b.init(this)},writeRegister:function(a,b){},readPRG:function(a){return a&32768?this.prgRead[a&32767]:24576<=a?this.ramData[a-
24576]:0},writePRG:function(a,b){a&32768?this.writeRegister(a,b):24576<=a&&(this.ramData[a-24576]=b)},loadPRGBank:function(a,b,c){b*=c;c=this.prgData.subarray(b,b+c);this.prgRead.set(c,a-32768)},readCHR:function(a){return this.chrRead[a]},writeCHR:function(a,b){this.chrBanks||(this.chrRead[a]=b);return b},readTile:function(a,b,c){a=(b<<4)+a+c;return this.readCHR(a)<<8|this.readCHR(a+8)},loadCHRBank:function(a,b,c){b*=c;c=this.chrData.subarray(b,b+c);this.chrRead.set(c,a)},getNameTableAddress:function(a){switch(this.mirroring){case 0:1024<=
a&&(a-=1024);2048<=a&&(a-=1024);break;case 1:a&=2047;break;case 2:throw Error("TODO, four screen mirroring");case 3:case 4:a&=1023,4===this.mirroring&&(a+=1024)}return a},readNameTable:function(a){return this.system.ppu.ram[this.getNameTableAddress(a)]},writeNameTable:function(a,b){this.system.ppu.ram[this.getNameTableAddress(a)]=b}};f.exports=d},{"./mappers":19}],11:[function(e,f,h){function d(a){this.system=a;this.controller0=new b;this.controller1=new b;this.controllers=Array(2);this.strobe=0}
function b(){}d.prototype={get:function(a){return a?this.controller1:this.controller0},connect:function(a,b){a?this.controller1=b:this.controller0=b},read:function(a){return this.get(a).read()},write:function(a){a&=1;this.controller0.setStrobe(a);this.controller1.setStrobe(a)}};b.prototype={read:function(a){return 0},setStrobe:function(){}};f.exports=d},{}],12:[function(e,f,h){function d(){this.strobe=this.mask=this.data=0;Object.preventExtensions(this)}d.prototype={press:function(a){this._press(b[a.toLowerCase()]||
0)},depress:function(a){this._depress(b[a.toLowerCase()]||0)},_press:function(a){a&3?this._depress(3):a&12&&this._depress(12);this.data|=a},_depress:function(a){this.data&=~a},read:function(){if(!this.mask)return 1;var a=this.data&this.mask;this.strobe||(this.mask>>=1);return+!!a},setStrobe:function(a){a&&(this.mask=128);this.strobe=a}};var b={a:128,b:64,select:32,start:16,up:8,down:4,left:2,right:1};f.exports=d},{}],13:[function(e,f,h){f.exports=function(d){function b(c){E((n&65280)>>8);E(n&255);
ba();E(D);S=1;n=ja(c);a(7)}function a(a){T+=a}function g(c){U=0;A=983040;switch(c){case 62:z();V();a(7);break;case 61:z();G();a(4);break;case 133:q();l(m);a(3);break;case 132:q();l(r);a(3);break;case 40:k();D=Q();ka();a(4);break;case 41:f();G();a(2);break;case 248:k();ca=1;a(2);break;case 249:x(r);H();a(4);break;case 246:y();da();a(6);break;case 32:p();c=n-1;E((c&65280)>>8);E(c&255);n=A;a(6);break;case 33:I();G();a(6);break;case 38:q();V();a(5);break;case 134:q();l(t);a(3);break;case 36:q();la();
a(3);break;case 37:q();G();a(2);break;case 53:y();G();a(3);break;case 54:y();V();a(6);break;case 49:J();G();a(5);break;case 48:h();K(u);a(2);break;case 57:x(r);G();a(4);break;case 56:k();B=1;a(2);break;case 140:p();l(r);a(4);break;case 44:p();la();a(4);break;case 253:z();H();a(4);break;case 254:z();da();a(7);break;case 45:p();G();a(4);break;case 46:p();V();a(6);break;case 186:k();t=L;u=t&128&&1;v=+(0===t);a(2);break;case 94:z();W();a(7);break;case 93:z();M();a(4);break;case 64:k();D=Q();ka();c=Q();
n=Q()<<8|c;a(6);break;case 65:I();M();a(6);break;case 69:q();M();a(3);break;case 70:q();W();a(5);break;case 72:k();E(m);a(3);break;case 73:f();M();a(2);break;case 174:p();X();a(4);break;case 173:p();N();a(4);break;case 172:p();Y();a(4);break;case 170:k();t=m;u=t&128&&1;v=+(0===t);a(2);break;case 74:e();W();a(2);break;case 76:p();n=A;a(3);break;case 77:p();M();a(4);break;case 78:p();W();a(6);break;case 81:J();M();a(5);break;case 80:h();K(!R);a(2);break;case 86:y();W();a(6);break;case 85:y();M();a(4);
break;case 154:k();L=t;a(2);break;case 229:q();H();a(3);break;case 89:x(r);M();a(4);break;case 88:k();S=0;a(2);break;case 42:e();V();a(2);break;case 169:f();N();a(2);break;case 168:k();r=m;u=r&128&&1;v=+(0===r);a(2);break;case 166:q();X();a(3);break;case 165:q();N();a(3);break;case 162:f();X();a(2);break;case 161:I();N();a(6);break;case 160:f();Y();a(2);break;case 164:q(0);Y();a(3);break;case 245:y();H();a(4);break;case 126:z();Z();a(7);break;case 125:z();O();a(4);break;case 240:h();K(v);a(2);break;
case 104:k();m=Q();u=m&128&&1;v=+(0===m);a(4);break;case 105:f();O();a(2);break;case 102:q();Z();a(5);break;case 101:q();O();a(3);break;case 96:k();c=Q();n=(Q()<<8|c)+1;a(6);break;case 97:I();O();a(6);break;case 206:p();ea();a(6);break;case 205:p();C(m);a(4);break;case 184:k();R=0;a(2);break;case 185:x(r);N();a(4);break;case 202:k();t=t-1&255;v=+(0===t);u=t&128&&1;a(2);break;case 204:p();C(r);a(4);break;case 176:h();K(B);a(2);break;case 177:J();N();a(5);break;case 182:q(r);X();a(4);break;case 180:y();
Y();a(4);break;case 181:y();N();a(4);break;case 138:k();m=t;u=m&128&&1;v=+(0===m);a(2);break;case 109:p();O();a(4);break;case 110:p();Z();a(6);break;case 108:var b=ja(n+1);c=b+1;255===(b&255)&&(c=b-255);b=w(b);A=w(c)<<8|b;n+=3;n=A;a(5);break;case 106:e();Z();a(2);break;case 121:x(r);O();a(4);break;case 120:k();S=1;a(2);break;case 113:J();O();a(5);break;case 112:h();K(R);a(2);break;case 117:y();O();a(4);break;case 118:y();Z();a(6);break;case 197:q();C(m);a(3);break;case 196:q();C(r);a(3);break;case 198:q();
ea();a(5);break;case 193:I();C(m);a(6);break;case 192:f();C(r);a(2);break;case 188:z();Y();a(4);break;case 228:q();C(t);a(3);break;case 201:f();C(m);a(2);break;case 200:k();r=r+1&255;u=r&128&&1;v=+(0===r);a(2);break;case 189:z();N();a(4);break;case 190:x(r);X();a(4);break;case 241:J();H();a(5);break;case 233:f();H();a(2);break;case 208:h();K(!v);a(2);break;case 209:J();C(m);a(5);break;case 157:z();l(m);a(5);break;case 8:k();ba();E(D|16);a(3);break;case 213:y();C(m);a(4);break;case 214:y();ea();a(6);
break;case 216:k();ca=0;a(2);break;case 217:x(r);C(m);a(4);break;case 6:q();aa();a(5);break;case 0:k();n+=1;E((n&65280)>>8);E(n&255);ba();E(D|16);c=w(65534);n=w(65535)<<8|c;a(7);break;case 1:I();P();a(6);break;case 236:p();C(t);a(4);break;case 5:q();P();a(2);break;case 234:k();a(2);break;case 129:I();l(m);a(6);break;case 238:p();da();a(6);break;case 237:p();H();a(4);break;case 30:z();aa();a(7);break;case 29:z();P();a(4);break;case 136:k();r=r-1&255;v=+(0===r);u=r&128&&1;a(2);break;case 9:f();P();
a(2);break;case 141:p();l(m);a(4);break;case 142:p();l(t);a(4);break;case 225:I();H();a(6);break;case 224:f();C(t);a(2);break;case 230:q();da();a(5);break;case 25:x(r);P();a(4);break;case 24:k();B=0;a(2);break;case 22:y();aa();a(6);break;case 21:y();P();a(3);break;case 232:k();t=t+1&255;u=t&128&&1;v=+(0===t);a(2);break;case 17:J();P();a(5);break;case 16:h();K(!u);a(2);break;case 150:q(r);l(t);a(4);break;case 149:y();l(m);a(4);break;case 148:y();l(r);a(4);break;case 221:z();C(m);a(4);break;case 222:z();
ea();a(7);break;case 145:J();l(m);a(6);break;case 144:h();K(!B);a(2);break;case 13:p();P();a(4);break;case 14:p();aa();a(6);break;case 10:e();aa();a(2);break;case 153:x(r);l(m);a(5);break;case 152:k();m=r;u=m&128&&1;v=+(0===m);a(2);break;default:n+=1}}function c(){if(!U&&983040===A)throw Error("invalid read");return U?m:w(A)}function l(a){U?m=a:d.memory.write(A,a);if(255<a)throw Error("invalid write");return a}function k(){n+=1}function e(){U=1;n+=1}function f(){A=n+1;n+=2}function h(){A=n+1;n+=2}
function p(){var a=w(n+2)<<8,c=w(n+1);A=a|c;n+=3}function q(a){A=w(n+1)+(a||0)&255;n+=2}function x(c){var b=w(n+2)<<8,g=w(n+1);A=(b|g)+c&65535;g+t&65280&&a(1);n+=3}function z(){x(t)}function y(){q(t)}function I(){var c=w(n+1),b=c+t,g=w(b&255);A=w(b+1&255)<<8|g;(c&65280)!==(b&65280)&&a(1);n+=2}function J(){var a=w(n+1),c=w(a);A=(w(a+1&255)<<8|c)+r&65535;n+=2}function O(){ma(c())}function ma(a){var c=m+a+B;R=!!((m^c)&(a^c)&128)&&1;u=!!(c&128);B=255<c;v=!(c&255);m=c&255}function G(){var a=c();m&=a;u=
m&128&&1;v=+(0===m)}function aa(){var a=l(c()),b=l(a<<1&254);B=a&128&&1;u=b&128&&1;v=+(0===b)}function K(b){var g=c(),d=n&65280;b&&(a(1),g&128&&(g=-((~g&255)+1)),n+=g,b=n&65280,d!==b&&a(1))}function la(){var a=c(),b=m&a;u=a&128&&1;R=a&64&&1;v=+(0===b)}function C(a){var b=c(),g=a-b&255;u=g&128&&1;B=+(a>=b);v=+(0===g)}function ea(){var a=l(l(c())-1&255);u=+!!(a&128);v=+(0===a)}function M(){m^=c();u=m&128&&1;v=+(0===m)}function da(){var a=l(l(c())+1&255);u=!!(a&128);v=0===a}function N(){m=c();u=m&128&&
1;v=+(0===m)}function X(){t=c();u=t&128&&1;v=+(0===t)}function Y(){r=c();u=r&128&&1;v=+(0===r)}function W(){var a=l(c());u=0;B=a&1&&1;v=+(0===l(a>>>1&255))}function P(){m|=c();u=m&128&&1;v=+(0===m)}function V(){var a=l(c());var b=l(a<<1&254|B);B=a&128&&1;v=+(0===b);u=b&128&&1}function Z(){var a=l(c());var b=l(a>>>1&255|(B?128:0));B=a&1;v=+(0===b);u=b&128&&1}function H(){ma(c()^255)}function w(a){return d.memory.read(a)}function ja(a){var c=w(a);a=w(a+1&65535)<<8;return c|a}function Q(){L=L+1&255;
return w(L|256)}function E(a){d.memory.write(L|256,a);L=L-1&255}function ka(){u=!!(D&128);R=!!(D&64);na=!!(D&16);ca=!!(D&8);S=!!(D&4);v=!!(D&2);B=!!(D&1)}function ba(){D=u<<7|R<<6|32|na<<4|ca<<3|S<<2|v<<1|B}var A,U,oa,T=0,m=0,t=0,r=0,L=0,n=32768,D=0,S=!1,na=!0,B=!1,u=!0,ca=!1,R=!1,v=!1,ha=!1,ia=!1;this.burn=a;this.reset=function(){b(65532)};this.tick=function(){--T;0<T||(T=0,ba(),ha&&!S&&(b(65534),ha=!1),oa=w(n),g(oa),ia&&(b(65530),ia=!1))};this.setPC=function(a){n=a};this.requestNMI=function(){ia=
!0};this.requestIRQ=function(){ha=!0};this.getCycles=function(){return T};this.resetCycles=function(){T=0};this.execute=g}},{}],14:[function(e,f,h){function d(b,a){this.controller=b;a&&this.configure(a);this.initialize();this.enabled=!1;this._pressed={}}d.prototype={initialize:function(){},configure:function(b){this.config=b;this._configure()},_configure:function(){},enable:function(){this.isSupported()&&!this.enabled&&(this.enabled=!0,this._enable())},_enable:function(){},disable:function(){this.enabled&&
(this.enabled=!1,this._disable())},_disable:function(){},isSupported:function(){return!0},press:function(b){this._pressed[b]=!0;this.controller.press(b)},depress:function(b){b in this._pressed&&(delete this._pressed[b],this.controller.depress(b))}};d.extend=function(b){Handler=function(a,c){d.call(this,a,c)};Handler.prototype=Object.create(d.prototype);for(var a in b)Handler.prototype[a]=b[a];return Handler};f.exports=d},{}],15:[function(e,f,h){e=e("./controllerhandler").extend({_configure:function(){this.config.index=
this.config.index||0},_enable:function(){this.initConnection()},_disable:function(){this.clearConnection();this.stopListening()},isSupported:function(){return"undefined"!==typeof window&&window.navigator&&"getGamepads"in window.navigator},initConnection:function(){if(!this._connected&&this.enabled){var d=this;this.checkConnectionInterval=setInterval(function(){d.initGamepad()&&d.clearConnection()},50)}},clearConnection:function(){this.checkConnectionInterval&&(clearInterval(this.checkConnectionInterval),
this.checkConnectionInterval=null)},initGamepad:function(){if(!this._connected)return navigator.getGamepads()[this.config.index]?(this.startListening(),!0):!1},startListening:function(){this._connected=!0;var d=this;requestAnimationFrame(function a(){var g=navigator.getGamepads()[d.config.index];g&&g.connected?(d.handleButtons(g),d.handleAxes(g),requestAnimationFrame(a)):d.stopListening()})},stopListening:function(){this._connected=!1;this.initConnection()},handleButtons:function(d){var b,a,g={},
c=this.config.buttons;d=d.buttons;for(a in c)g[c[a]]=!1;for(a=0;a<d.length;a++)(b=c[a])&&(g[b]=g[b]||d[a].pressed);for(b in g)g[b]?this.press(b):this.depress(b)},handleAxes:function(d){var b={vertical:["up","down"],horizontal:["left","right"]},a={},g=this.config.axes,c=d.axes;for(k in b)a[k]=!1;for(var l=0;l<c.length;l++){var k=g[l];d=c[l];if(k&&d){a[k]=!0;var e=b[k];this.press(0>d?e[0]:e[1]);this.depress(0>d?e[1]:e[0])}}for(k in a)if(!a[k])for(e=b[k],l=0;l<e.length;l++)this.depress(e[l])}});f.exports=
e},{"./controllerhandler":14}],16:[function(e,f,h){function d(a){this.system=a;this.controllers=a.controllers;this.inputHandlers=Array(2);this.initConfig();"undefined"!==typeof window&&this.enable()}h=e("./gamepad");var b=e("./keyboard");e=e("../controllers/standardcontroller");d.prototype={enable:function(){this._setEnabled(!0)},disable:function(){this._setEnabled(!1)},_setEnabled:function(a){var c,b=a?"enable":"disable";this._enabled=a;for(var g=0;g<this.inputHandlers.length;g++)if(a=this.inputHandlers[g])for(c in a)a[c][b]()},
initConfig:function(){var a,b=this.config=this.system.config.input;for(a=0;a<b.length;a++){var g=b[a];this.setController(a,g.type);var d=g.controls;Array.isArray(d)||(d=[d]);for(g=0;g<d.length;g++)this.configure(a,d[g].type,d[g].config)}},setController:function(c,b){this.controllers.connect(c,new a[b])},configure:function(a,b,d){var c,k=g[b],l=this.controllers.get(a);this.initInputHandlers(a);(c=this.inputHandlers[a][b])&&c.disable();this.inputHandlers[a][b]=new k(l,d);this._enabled&&this.inputHandlers[a][b].enable()},
initInputHandlers:function(a){this.inputHandlers[a]=this.inputHandlers[a]||{}}};var a={standard:e},g={gamepad:h,keyboard:b};f.exports=d},{"../controllers/standardcontroller":12,"./gamepad":15,"./keyboard":17}],17:[function(e,f,h){e=e("./controllerhandler").extend({initialize:function(){this.handlers={}},_configure:function(){this.initKeyCodes()},_enable:function(){this.bindHandler("keydown");this.bindHandler("keyup")},_disable:function(){this.unbindHandler("keydown");this.unbindHandler("keyup")},
bindHandler:function(b){window.addEventListener(b,this.getHandler(b))},unbindHandler:function(b){window.removeEventListener(b,this.getHandler(b))},getHandler:function(b){if(this.handlers[b])return this.handlers[b];var a=this,g="keydown"===b?"press":"depress";this.handlers[b]=function(c){var b=c.keyCode;b in a.keyCodes&&(a[g](a.keyCodes[b]),c.preventDefault())};return this.handlers[b]},initKeyCodes:function(){var b,a={};for(b in this.config){var g=b in d?d[b]:b.toUpperCase().charCodeAt();a[g]=this.config[b]}this.keyCodes=
a}});var d={backspace:8,tab:9,"return":13,shift:16,ctrl:17,alt:18,capslock:20,space:32,left:37,up:38,right:39,down:40};f.exports=e},{"./controllerhandler":14}],18:[function(e,f,h){f.exports={init:function(){this.axRomBanks=this.prgBanks>>1;this.setPrgBank(0)},setPrgBank:function(d){this.prgBank=d;this.loadPRGBank(32768,d,32768)},writeRegister:function(d,b){this.setPrgBank(b&7);this.mirroring=b&16?4:3}}},{}],19:[function(e,f,h){f=e("./nrom");var d=e("./mmc1"),b=e("./mmc2"),a=e("./mmc3"),g=e("./uxrom");
e=e("./axrom");var c={};c[0]=f;c[1]=d;c[2]=g;c[4]=a;c[7]=e;c[9]=b;h.init=function(a){var b;var g=a.mapper;if(!(g in c))throw Error("Unknown mapper "+g);g=c[g];for(b in g)a[b]=g[b];a.init()}},{"./axrom":18,"./mmc1":20,"./mmc2":21,"./mmc3":22,"./nrom":23,"./uxrom":24}],20:[function(e,f,h){var d=[3,4,1,0];f.exports={init:function(){this.lastPRG=this.prgBanks-1;this.chrBank0=this.prgBank=0;this.chrBank1=1;this.registerShift=this.registerWrites=0;this.mapperControl(12)},mapperControl:function(b){this.mapperFlags=
b;this.mirroring=d[b&3];this.prgMode=(b&12)>>2;this.chrMode=(b&16)>>4;this.setPRGBanks()},setRegister:function(b,a){switch(b&24576){case 0:this.mapperControl(a);break;case 8192:this.chrBank0=a;this.setChrBanks();break;case 16384:this.chrBank1=a;this.setChrBanks();break;case 24576:this.prgBank=a&15,this.setPRGBanks()}this.registerShift=this.registerWrites=0},setPRGBanks:function(){switch(this.prgMode){case 0:case 1:var b=this.prgBank&-2;var a=this.prgBank+1;break;case 2:b=0;a=this.prgBank;break;case 3:b=
this.prgBank,a=this.lastPRG}this.loadPRGBank(32768,b,16384);this.loadPRGBank(49152,a,16384)},setChrBanks:function(){if(this.chrMode){var b=this.chrBank0;var a=this.chrBank1;2>this.chrBanks&&(b&=1,a&=1)}else b=this.chrBank0&-2,a=b+1;this.loadCHRBank(0,b,4096);this.loadCHRBank(4096,a,4096)},writeRegister:function(b,a){a&128?(this.registerWrites=this.registerShift=0,this.mapperControl(this.mapperFlags|12)):(this.registerShift=this.registerShift>>1|(a&1)<<4,this.registerWrites++,5===this.registerWrites&&
this.setRegister(b,this.registerShift))}}},{}],21:[function(e,f,h){f.exports={init:function(){this.setPrgBank(0);this.mmc2PRG=this.prgBanks<<1;this.loadPRGBank(40960,this.mmc2PRG-3,8192);this.loadPRGBank(49152,this.mmc2PRG-2,8192);this.loadPRGBank(57344,this.mmc2PRG-1,8192);this.chrLatch1=this.chrLatch0=!1;this.chrBankB=this.chrBankA=this.chrBank2=this.chrBank3=this.chrBank0=this.chrBank1=0;this.setChrBanks();this.initLatchSwitches();this._readCHR=Object.getPrototypeOf(this).readCHR},initLatchSwitches:function(){var d,
b=new Uint8Array(8192);b[4056]=1;b[4072]=2;for(d=8152;8160>d;d++)b[d]=3;for(d=8168;8176>d;d++)b[d]=4;this.latchSwitches=b},setChrBanks:function(){var d=this.chrLatch1?this.chrBank3:this.chrBank2;this.loadCHRBank(0,this.chrLatch0?this.chrBank1:this.chrBank0,4096);this.loadCHRBank(4096,d,4096)},setPrgBank:function(d){this.prgBank=d;this.loadPRGBank(32768,this.prgBank,8192)},writeRegister:function(d,b){switch(d&28672){case 8192:this.setPrgBank(b&15);break;case 12288:this.chrBank0=b&31;break;case 16384:this.chrBank1=
b&31;break;case 20480:this.chrBank2=b&31;break;case 24576:this.chrBank3=b&31;break;case 28672:this.mirroring=+!(b&1)}this.setChrBanks()},readCHR:function(d){var b=this._readCHR(d);switch(this.latchSwitches[d]){case 1:this.chrLatch0&&(this.chrLatch0=!1,this.setChrBanks());break;case 2:this.chrLatch0||(this.chrLatch0=!0,this.setChrBanks());break;case 3:this.chrLatch1&&(this.chrLatch1=!1,this.setChrBanks());break;case 4:this.chrLatch1||(this.chrLatch1=!0,this.setChrBanks())}return b}}},{}],22:[function(e,
f,h){f.exports={init:function(){this.lastA14=0;this.irqEnabled=!1;this.irqCounterReset=this.irqCounter=0;this.willReloadIRQ=!1;this.prgBank0=0;this.prgBank1=1;this.prgBase0=32768;this.prgBase1=40960;this.mmc3PRG=this.prgBanks<<1;this.lastPRG=this.mmc3PRG-1;this.lastPRG2=this.lastPRG-1;this.mmc3CHR=this.chrBanks<<3;this.setBankSelect(0);this._readCHR=Object.getPrototypeOf(this).readCHR},setBankSelect:function(d){var b=+!!(d&64),a=+!!(d&128);this.bankSelectMode=d&7;b!==this.prgMode&&this.setPRGMode(b);
a!==this.chrMode&&this.setCHRMode(a)},setPRGMode:function(d){(this.prgMode=d)?(this.loadPRGBank(32768,this.lastPRG2,8192),this.prgBase0=49152):(this.loadPRGBank(49152,this.lastPRG2,8192),this.prgBase0=32768);this.loadPRGBank(57344,this.lastPRG,8192);this.prgBase1=40960;this.setPRGBanks()},setBank:function(d){var b=0;switch(this.bankSelectMode){case 1:b=1;case 0:b=this.chrBigBase+2048*b;this.loadCHRBank(b,d&-2,1024);this.loadCHRBank(b+1024,d|1,1024);break;case 2:case 3:case 4:case 5:b=this.bankSelectMode-
2;b=this.chrSmallBase+1024*b;this.loadCHRBank(b,d,1024);break;case 6:this.prgBank0=d&this.mmc3PRG-1;this.setPRGBanks();break;case 7:this.prgBank1=d&this.mmc3PRG-1,this.setPRGBanks()}},setPRGBanks:function(){this.loadPRGBank(this.prgBase0,this.prgBank0,8192);this.loadPRGBank(this.prgBase1,this.prgBank1,8192)},setCHRMode:function(d){(this.chrMode=d)?(this.chrBigBase=4096,this.chrSmallBase=0):(this.chrBigBase=0,this.chrSmallBase=4096)},setMirroring:function(d){this.mirroring=+!(d&1)},setRAMProtect:function(){},
reloadIRQ:function(){this.willReloadIRQ=!0},setIRQCounter:function(d){this.irqCounterReset=d},enableIRQ:function(d){this.irqEnabled=d},writeRegister:function(d,b){var a=d&1;switch(d&24576){case 0:a?this.setBank(b):this.setBankSelect(b);break;case 8192:a?this.setRAMProtect(b):this.setMirroring(b);break;case 16384:a?this.reloadIRQ():this.setIRQCounter(b);break;case 24576:this.enableIRQ(!!a)}},readCHR:function(d){var b=d&4096;b&&b!==this.lastA14&&this.clockScanlineCounter();this.lastA14=b;return this._readCHR(d)},
clockScanlineCounter:function(){this.willReloadIRQ||!this.irqCounter?(this.irqCounter=this.irqCounterReset,this.willReloadIRQ=!1):(this.irqCounter--,!this.irqCounter&&this.irqEnabled&&this.system.cpu.requestIRQ())}}},{}],23:[function(e,f,h){f.exports={init:function(){1===this.prgBanks?(this.loadPRGBank(32768,0,16384),this.loadPRGBank(49152,0,16384)):this.loadPRGBank(32768,0,32768)},readCHR:function(d){return this.chrData[d]},writeCHR:function(d,b){this.chrBanks||(this.chrData[d]=b);return b}}},{}],
24:[function(e,f,h){f.exports={init:function(){this.prgBank=0;this.loadPRGBank(32768,this.prgBank,16384);this.loadPRGBank(49152,this.prgBanks-1,16384)},writeRegister:function(d,b){this.prgBank=b&15;this.loadPRGBank(32768,this.prgBank,16384)}}},{}],25:[function(e,f,h){function d(b){var a=0;this.system=b;for(this.ram=new Uint8Array(2048);2048>a;a++)this.ram[a]=255;this.address=0;this.cartridge=null;Object.preventExtensions(this)}d.prototype={loadCartridge:function(b){this.cartridge=b},readWrite:function(b,
a,g){this.address=b;switch(b){case 16404:if(a){a=g<<8;for(b=0;256>b;b++)this.write(8196,this.read(a+b));this.system.cpu.burn(513)}return 0;case 16406:return a?(this.system.controllers.write(g),0):this.system.controllers.read(0);case 16407:if(!a)return this.system.controllers.read(1)}if(16416<=b)return a?this.system.cartridge.writePRG(b,g):this.system.cartridge.readPRG(b);if(8192>b)return b&=2047,a?(this.ram[b]=g,0):this.ram[b];if(16384>b)return b&=7,a?this.system.ppu.writeRegister(b,g):this.system.ppu.readRegister(b);
b&=255;return a?this.system.apu.writeRegister(b,g):this.system.apu.readRegister(b)},read:function(b){return this.readWrite(b,!1,0)},write:function(b,a){return this.readWrite(b,!0,a)}};f.exports=d},{}],26:[function(e,f,h){function d(){this.bufferIndex=0;this.bufferLength=8192;this.sampleRate=44100;this.volume=1;this.playing=null;this.setEnabled(!0)}d.prototype={writeSample:function(b){this.bufferData[this.bufferIndex++]=b;this.bufferIndex===this.bufferLength&&(this.bufferIndex=0,this.playing&&this.playing.stop(),
this.bufferSource.buffer=this.buffer,this.playing=this.bufferSource,this.playing.start(0),this.initBuffer())},setEnabled:function(b){(this.enabled=b&&this.isSupported())&&this.initHardware()},setVolume:function(b){this.volume=this.gainNode.gain.value=b},initHardware:function(){this.context||(this.initContext(),this.initBuffer())},initContext:function(){this.context=new AudioContext;this.sampleRate=this.context.sampleRate;this.gainNode=this.context.createGain();this.gainNode.connect(this.context.destination)},
initBuffer:function(){this.buffer=this.context.createBuffer(1,this.bufferLength,this.context.sampleRate);this.bufferData=this.buffer.getChannelData(0);this.bufferSource=this.context.createBufferSource();this.bufferSource.connect(this.gainNode)},isSupported:function(){return"undefined"!==typeof AudioContext}};f.exports=d},{}],27:[function(e,f,h){var d=e("./audiooutput"),b=e("./videooutput");f.exports=function(){this.audio=new d;this.video=new b}},{"./audiooutput":26,"./videooutput":31}],28:[function(e,
f,h){function d(a){this.el=a;this.initData();this.initPalette()}var b=e("./palette").data;d.isSupported=function(a){return!!a.getContext("2d")};d.prototype={renderFrame:function(a){var b=a.bgBuffer,c=a.spriteBuffer,d=a.prioBuffer;a=a.bgColor;var k=this.reds,e=this.greens,f=this.blues,h=b.length;data=this.data;for(var p=0,q=0,x;p<h;p++)x=b[p],!c[p]||d[p]&&x||(x=c[p]),x=x||a,data[q++]=k[x],data[q++]=e[x],data[q++]=f[x],q++;this.image.data.set(data);this.context.putImageData(this.image,0,0)},initData:function(){this.width=
256;this.height=224;this.data=new Uint8Array(this.width*this.height*4);for(var a=0;a<this.data.length;a++)this.data[a]=255;this.context=this.el.getContext("2d");this.image=this.context.getImageData(0,0,this.width,this.height);this.index=0},initPalette:function(){var a,g,c=0,d=new ArrayBuffer(192),k=new Uint8Array(d);for(a=0;3>a;a+=1)for(g=0;192>g;g+=3)k[c]=b[g+a],c+=1;this.palette=b;this.reds=new Uint8Array(d,0,64);this.greens=new Uint8Array(d,64,64);this.blues=new Uint8Array(d,128,64)}};f.exports=
d},{"./palette":29}],29:[function(e,f,h){h.data=new Uint8Array([102,102,102,0,42,136,20,18,167,59,0,164,92,0,126,110,0,64,108,7,0,86,29,0,51,53,0,12,72,0,0,82,0,0,79,8,0,64,77,0,0,0,0,0,0,0,0,0,173,173,173,21,95,217,66,64,255,117,39,254,160,26,204,183,30,123,181,49,32,153,78,0,107,109,0,56,135,0,13,147,0,0,143,50,0,124,141,0,0,0,0,0,0,0,0,0,255,255,255,100,176,255,146,144,255,198,118,255,242,106,255,255,110,204,255,129,112,234,158,34,188,190,0,136,216,0,92,228,48,69,224,130,72,205,222,79,79,79,0,
0,0,0,0,0,255,255,255,192,223,255,211,210,255,232,200,255,250,194,255,255,196,234,255,204,197,247,216,165,228,229,148,207,239,150,189,244,171,179,243,204,181,235,242,184,184,184,0,0,0,0,0,0])},{}],30:[function(e,f,h){function d(a){this.el=a;this.initGL()}function b(a){return a.getContext("webgl")||a.getContext("experimental-webgl")}var a=e("./palette").data;d.isSupported=function(a){return!!b(a)};d.prototype={renderFrame:function(b){var c=this.gl;c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);
c.activeTexture(c.TEXTURE0);c.bindTexture(c.TEXTURE_2D,this.bgTexture);c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,256,224,0,c.LUMINANCE,c.UNSIGNED_BYTE,b.bgBuffer);c.activeTexture(c.TEXTURE1);c.bindTexture(c.TEXTURE_2D,this.spriteTexture);c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,256,224,0,c.LUMINANCE,c.UNSIGNED_BYTE,b.spriteBuffer);c.activeTexture(c.TEXTURE2);c.bindTexture(c.TEXTURE_2D,this.prioTexture);c.texImage2D(c.TEXTURE_2D,0,c.LUMINANCE,256,224,0,c.LUMINANCE,c.UNSIGNED_BYTE,b.prioBuffer);c.activeTexture(c.TEXTURE3);
c.bindTexture(c.TEXTURE_2D,this.paletteTexture);var g=c.getAttribLocation(this.program,"vertCoord");c.enableVertexAttribArray(g);c.vertexAttribPointer(g,2,c.FLOAT,!1,0,0);b=3*b.bgColor;c.uniform4f(this.bgColorLocation,a[b]/256,a[b+1]/256,a[b+2]/256,1);c.drawArrays(c.TRIANGLES,0,6)},initGL:function(){var a=this.gl=b(this.el);a.viewport(0,0,256,224);this.initShaders();this.initProgram();this.initBuffers();this.initTextures();this.bgColorLocation=a.getUniformLocation(this.program,"bgColor")},initBuffers:function(){var a=
this.gl,b=this.buffer=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),a.STATIC_DRAW)},initTextures:function(){function b(a,b){var g=c.createTexture();c.bindTexture(c.TEXTURE_2D,g);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);
c.uniform1i(c.getUniformLocation(d,b),a);return g}var c=this.gl,d=this.program;this.bgTexture=b(0,"bgTexture");this.spriteTexture=b(1,"spriteTexture");this.prioTexture=b(2,"prioTexture");this.paletteTexture=b(3,"paletteTexture");c.texImage2D(c.TEXTURE_2D,0,c.RGB,64,1,0,c.RGB,c.UNSIGNED_BYTE,a)},initShaders:function(){function a(a,c){a=b.createShader(a);b.shaderSource(a,c);b.compileShader(a);if(!b.getShaderParameter(a,b.COMPILE_STATUS))throw"An error occurred compiling the shaders: "+b.getShaderInfoLog(a);
return a}var b=this.gl;this.fragmentShader=a(b.FRAGMENT_SHADER,"precision mediump float;\nuniform sampler2D bgTexture;\nuniform sampler2D spriteTexture;\nuniform sampler2D prioTexture;\nuniform sampler2D paletteTexture;\nuniform vec4 bgColor;\nvarying vec2 texCoord;\nvoid main(void) {\nfloat bgIndex = texture2D(bgTexture, texCoord).r;\nfloat spriteIndex = texture2D(spriteTexture, texCoord).r;\nfloat prioIndex = texture2D(prioTexture, texCoord).r;\nfloat colorIndex = ((spriteIndex > 0.0 && (prioIndex == 0.0 || bgIndex == 0.0)) ? spriteIndex : bgIndex);\nvec4 color = texture2D(paletteTexture, vec2( colorIndex * 4.0 + 0.0078, 0.5));\nif ( colorIndex > 0.0 ) {\ngl_FragColor = color;\n} else {\ngl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\ngl_FragColor = bgColor;\n}\n}");
this.vertexShader=a(b.VERTEX_SHADER,"attribute vec2 vertCoord;varying vec2 texCoord;void main() {gl_Position = vec4(vertCoord, 0, 1);texCoord = vec2( 0.5 * ( vertCoord.x + 1.0 ), 0.5 * (1.0 - vertCoord.y));}")},initProgram:function(){var a=this.gl,b=a.createProgram();a.attachShader(b,this.vertexShader);a.attachShader(b,this.fragmentShader);a.linkProgram(b);a.useProgram(b);this.program=b}};f.exports=d},{"./palette":29}],31:[function(e,f,h){function d(){this.pixelBuffer=new Uint8Array(57600);this.bgBuffer=
new Uint8Array(57600);this.spriteBuffer=new Uint8Array(57600);this.prioBuffer=new Uint8Array(57600);this.bgColor=this.index=0}var b=e("./renderer/webgl"),a=e("./renderer/canvas2d");d.prototype={force2D:!1,run:function(){var a=this;requestAnimationFrame(function l(){requestAnimationFrame(l);a.renderer.renderFrame(a)})},reset:function(a){this.index=0;this.bgColor=a},setIntensity:function(a,b,d){},setGrayscale:function(a){},outputScanline:function(a,b,d){this.bgBuffer.set(a,this.index);this.spriteBuffer.set(b,
this.index);this.prioBuffer.set(d,this.index);this.index+=256},setElement:function(a){this.el=a;this.initRenderer()},initRenderer:function(){if(!this.force2D&&b.isSupported(this.el))this.renderer=new b(this.el);else if(a.isSupported(this.el))this.renderer=new a(this.el);else throw Error("No supported renderer!");}};f.exports=d},{"./renderer/canvas2d":28,"./renderer/webgl":30}],32:[function(e,f,h){function d(a){this.ppu=a;this.memory=a.memory;this.enabledLeft=this.enabled=!0;this.y=this.x=this.baseTable=
this.loopyX=this.loopyW=this.loopyT=this.loopyV=this.pixelOffset=0;this.scanlineColors=new Uint8Array(256);this.scanlineReset=new Uint8Array(256);Object.preventExtensions(this)}var b=e("../utils/bitmap"),a=function(){var a,b=new Uint16Array(32768);for(a=0;32768>a;a++)b[a]=9152|a&3072|a>>4&56|a>>2&7;return b}(),g=function(){var a,b=new Uint8Array(400);for(a=7;256>a;a+=8)b[a]=1;for(a=327;336>a;a+=8)b[a]=1;return b}(),c=function(){var a,b,c=new Uint8Array(256);for(a=0;4>a;a++)for(b=0;8>b;b+=2)c[a<<b]=
a<<2;return c}(),l=function(){var a,b=new Uint8Array(65536);for(a=0;65536>a;a++){var c=3;a&2&&(c<<=2);a&64&&(c<<=4);b[a]=c}return b}();d.prototype={toggle:function(a){this.enabled=!!a},toggleLeft:function(a){this.enabledLeft=!!a},writeAddress:function(a){this.loopyW?this.loopyV=this.loopyT=this.loopyT&65280|a&255:this.loopyT=this.loopyT&255|(a&63)<<8;this.loopyW=!this.loopyW},writeScroll:function(a){this.loopyW?(this.loopyT&=-29665,this.loopyT|=(a&7)<<12,this.loopyT|=(a&248)<<2,this.loopyW=0):(this.loopyT&=
32736,this.loopyT|=a>>3,this.loopyX=a&7,this.loopyW=1)},evaluate:function(){var a=this.ppu,b=a.lineCycle;g[b]&&this.fetchTile();-1===a.scanline&&280<b&&304>b&&(this.loopyV=this.loopyV&1055|this.loopyT&31712)},initScanline:function(){this.pixelOffset=this.enabledLeft?0:8},endScanline:function(){this.incrementVY();this.loopyV=this.loopyV&31712|this.loopyT&1055;this.scanlineColors.set(this.scanlineReset);this.x=-this.loopyX},incrementVX:function(){this.loopyV=31===(this.loopyV&31)?this.loopyV&65504^
1024:this.loopyV+1;this.x+=8},incrementVY:function(){if(28672!=(this.loopyV&28672))this.loopyV+=4096;else{this.loopyV&=-28673;var a=(this.loopyV&992)>>>5;29==a?(a=0,this.loopyV^=2048):a=31==a?0:a+1;this.loopyV=this.loopyV&-993|a<<5}this.y=(this.loopyV&28672)>>12},fetchTile:function(){var b=this.memory.cartridge,d=b.readNameTable(a[this.loopyV]&8191),g=b.readNameTable((8192|this.loopyV&4095)&8191);(b=b.readTile(this.baseTable,g,this.y))&&this.renderTile(b,c[d&l[this.loopyV&4095]]);this.incrementVX()},
renderTile:function(a,c){a=b.getColors(a);for(var d,g=Math.max(this.pixelOffset,this.x),e=Math.min(255,this.x+7),f=7-(e-g);e>=g;e--)(d=a[f++])&&(this.scanlineColors[e]=this.ppu.memory.palette[c|d])},setNameTable:function(a){this.loopyT=this.loopyT&-3073|a<<10}};f.exports=d},{"../utils/bitmap":36}],33:[function(e,f,h){function d(c){this.system=c;this.ram=new Uint8Array(2048);this.enabled=!0;this.vBlank=this.frameEnded=!1;this.warmup=2;this.scanline=-1;this.lineCycle=0;this.increment=1;this.masterSlave=
0;this.yInRange=this.pixelInRange=this.checkNMI=this.nmiOccurred=this.sprite0Hit=this.generateNMI=!1;this.inRenderScanline=!0;this.countdown=this.readBuffer=0;this.memory=new g(this);this.background=new b(this);this.sprites=new a(this);this.output=this.system.output.video;Object.preventExtensions(this)}var b=e("./background"),a=e("./sprites"),g=e("./memory");d.prototype={readStatus:function(){var a=!!this.nmiOccurred<<7|!!this.sprite0Hit<<6|!!this.sprites.spriteOverflow<<5;this.nmiOccurred=!1;return a},
mask:function(a){this.output.setGrayscale(a&1);this.output.setIntensity(a&32,a&64,a&128);this.sprites.toggle(a&16);this.sprites.toggleLeft(a&4);this.background.toggle(a&8);this.background.toggleLeft(a&2);this.enabled=this.sprites.enabled||this.background.enabled},control:function(a){var b=a&4,c=a&8,d=a&16,g=a&32,e=a&128;this.background.setNameTable(a&3);this.increment=b?32:1;this.sprites.baseTable=c?4096:0;this.background.baseTable=d?4096:0;this.sprites.spriteSize=g?16:8;this.generateNMI=!!e},readRegister:function(a){switch(a){case 2:return a=
this.readStatus(),this.background.loopyW=0,a;case 4:return this.sprites.readOAM();case 7:return a=this.readBuffer,this.readBuffer=this.memory.read(this.background.loopyV),16128===(this.background.loopyV&16128)&&(a=this.readBuffer,this.readBuffer=this.memory.read(this.background.loopyV&12287)),this.background.loopyV+=this.increment,a}},writeRegister:function(a,b){switch(a){case 0:this.control(b);break;case 1:this.mask(b);break;case 3:this.sprites.oamAddress=b;break;case 4:this.sprites.writeOAM(b);
break;case 5:this.background.writeScroll(b);break;case 6:this.background.writeAddress(b);break;case 7:this.memory.write(this.background.loopyV,b),this.background.loopyV+=this.increment}},tick:function(){var a=this.sprites,b=this.background;this.inRenderScanline?(this.enabled&&(b.evaluate(),a.evaluate()),this.pixelInRange&&this.pixelInRange&&a.sprite0InRange&&a.scanlineSprite0[this.lineCycle-1]&&!this.sprite0Hit&&(this.sprite0Hit=!!b.scanlineColors[this.lineCycle-1]),this.incrementRenderCycle()):this.incrementIdleCycle()},
incrementRenderCycle:function(){switch(++this.lineCycle){case 1:this.background.initScanline();this.sprites.initScanline();this.pixelInRange=this.yInRange;break;case 257:this.pixelInRange=!1;this.yInRange&&this.output.outputScanline(this.background.scanlineColors,this.sprites.scanlineColors,this.sprites.scanlinePriority);this.enabled&&(this.background.endScanline(),this.sprites.endScanline());break;case 341:this.incrementScanline()}},incrementIdleCycle:function(){this.countdown--||(this.scanline=
-1,this.inRenderScanline=this.frameEnded=!0,this.checkNMI=this.vBlank=this.nmiOccurred=!1,this.sprite0Hit=this.sprites.spriteOverflow=!1)},incrementScanline:function(){this.scanline++;this.lineCycle=0;switch(this.scanline){case 8:this.output.reset(this.memory.palette[0]);this.yInRange=!0;break;case 233:this.yInRange=!1;break;case 240:this.inRenderScanline=!1,this.vBlank=this.nmiOccurred=this.checkNMI=!0,this.generateNMI&&this.system.cpu.requestNMI(),this.countdown=6800}}};f.exports=d},{"./background":32,
"./memory":34,"./sprites":35}],34:[function(e,f,h){function d(b){this.ppu=b;this.system=b.system;this.palette=new Uint8Array(32);this.cartridge=null;Object.preventExtensions(this)}d.prototype={loadCartridge:function(b){this.cartridge=b},read:function(b){return this._readWrite(b,0,0)},write:function(b,a){this._readWrite(b,a,1)},_readWrite:function(b,a,d){b&=16383;if(b&-8192)if(b&-12288){if(16128>b)return this._readWrite(b-4096,a,d);if(16383>b){b&=31;0===(b&3)&&(b&=-17);if(d)this.palette[b]=a;else return this.palette[b];
return 0}}else return b&=8191,d?(this.cartridge.writeNameTable(b,a),0):this.cartridge.readNameTable(b);else return d?this.cartridge.writeCHR(b,a):this.cartridge.readCHR(b)}};f.exports=d},{}],35:[function(e,f,h){function d(a){this.ppu=a;this.memory=a.memory;this.enabledLeft=this.enabled=!0;this.oamAddress=this.pixelOffset=0;this.oam=new Uint8Array(256);this.oam2=new Uint8Array(33);this.oam2reset=new Uint8Array(this.oam2.length);for(a=0;a<this.oam2reset.length;a++)this.oam2reset[a]=255;this.currentSprite=
this.spriteProgress=0;this.spriteSize=8;this.baseTable=0;this.scanlineOverflow=this.spriteOverflow=this.sprite0InRange=this.sprite0Next=!1;this.nextSpriteCount=this.spriteCount=0;this.yCounters=new Uint8Array(64);this.yCountersReset=new Uint8Array(this.yCounters.length);this.nextScanlineSprite0=new Uint8Array(256);this.nextScanlinePriority=new Uint8Array(256);this.nextScanlineColors=new Uint8Array(256);this.scanlineSprite0=new Uint8Array(256);this.scanlinePriority=new Uint8Array(256);this.scanlineColors=
new Uint8Array(256);this.scanlineReset=new Uint8Array(this.scanlineColors.length);Object.preventExtensions(this)}var b=e("../utils/bitmap"),a=function(){var a,b=new Uint8Array(512);for(a=264;320>=a;a+=8)b[a]=1;return b}();d.prototype={toggle:function(a){this.enabled=!!a},toggleLeft:function(a){this.enabledLeft=!!a},evaluate:function(){a[this.ppu.lineCycle]&&this.fetchTile()},initScanline:function(){this.currentSprite=0;this.sprite0InRange=this.sprite0Next;this.scanlineOverflow=this.sprite0Next=!1;
this.oamAddress=0;this.clearSecondaryOAM();this.scanlineSprite0.set(this.nextScanlineSprite0);this.scanlinePriority.set(this.nextScanlinePriority);this.scanlineColors.set(this.nextScanlineColors);this.nextSpriteCount&&(this.nextScanlineSprite0.set(this.scanlineReset),this.nextScanlinePriority.set(this.scanlineReset),this.nextScanlineColors.set(this.scanlineReset));this.spriteCount=this.nextSpriteCount;this.nextSpriteCount=0},endScanline:function(){this.initSecondaryOAM()},readOAM:function(){return this.ppu.vBlank?
this.oam[this.oamAddress]:0},writeOAM:function(a){this.ppu.vBlank&&(this.oam[this.oamAddress]=a,this.oamAddress=this.oamAddress+1&255)},clearSecondaryOAM:function(){this.oam2.set(this.oam2reset);-1===this.ppu.scanline&&this.yCounters.set(this.yCountersReset)},initSecondaryOAM:function(){var a=this.ppu;if(a.enabled){for(var b,d=0,e=this.oamAddress,f=0;64>f;f++)b=this.oam[e],this.oam2[d]=b,a.scanline===b&&(this.yCounters[f]=this.spriteSize),this.yCounters[f]&&(this.scanlineOverflow?this.spriteOverflow=
!0:(this.oam2.set(this.oam.subarray(e,e+4),d),0===f&&(this.sprite0Next=!0),this.nextSpriteCount++,d+=4,32===d&&(this.scanlineOverflow=!0)),this.yCounters[f]--),e+=4;this.oamAddress=e;this.oam2[d]=0}},fetchTile:function(){var a=this.currentSprite<<2,c=this.oam2[a],d=this.oam2[a+1],e=this.oam2[a+2];a=this.oam2[a+3];var f=this.baseTable,h=e&64;var F=e&128;c=this.ppu.scanline-c&this.spriteSize-1;16===this.spriteSize&&(f=d&1?4096:0,d&=-2,7<c?(c-=8,F||d++):F&&d++);F&&(c=8-c-1);d=this.memory.cartridge.readTile(f,
d,c);h&&(d=b.reverseTile(d));this.currentSprite<this.nextSpriteCount&&this.renderTile(a,d,e);this.currentSprite+=1},renderTile:function(a,c,d){c=b.getColors(c);var e=16|(d&3)<<2;d&=32;for(var g=0===this.currentSprite&&this.sprite0Next,f,h=8;0<=h&&a>=this.pixelOffset&&256>a;h--)!this.nextScanlineColors[a]&&(f=c[h])&&(this.nextScanlineColors[a]=this.ppu.memory.palette[e|f],this.nextScanlinePriority[a]=d,this.nextScanlineSprite0[a]=g),a++}};f.exports=d},{"../utils/bitmap":36}],36:[function(e,f,h){var d=
function(){var a,b,d=new Uint8Array(16777216);for(a=0;256>a;a++)for(b=0;256>b;b++)for(var e,f,h=a,F=b,p=h<<16|F<<8,q=0;8>q;q++)f=h&1,e=(F&1)<<1,e|=f,d[p+q]=e,h>>=1,F>>=1;return d}(),b=function(){var a,b=new Uint8Array(256);for(a=0;256>a;a++){var d=a,e,f=a,h=0;for(e=7;0<=e;e--)h|=(f&1)<<e,f>>>=1;b[d]=h}return b}(),a=function(){var a,c,d=new Uint16Array(65536);for(a=0;256>a;a++)for(c=0;256>c;c++){var e=a<<8|c;var f=b[a]<<8|b[c];d[e]=f}return d}();h.getColors=function(a){a<<=8;return d.subarray(a,a+
8)};h.reverseByte=function(a){return b[a]};h.reverseTile=function(b){return a[b]}},{}]},{},[3])(3)});
